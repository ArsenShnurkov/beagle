<html>
<head><title>Beagle Search Web Interface</title>

<script language="JavaScript1.2">
	 var xmlhttp=false;
	 try { 
	 	xmlhttp = new ActiveXObject("Msxml2.XMLHTTP"); 
	 } catch (e) {
	 	try { 
			xmlhttp = new ActiveXObject("Microsoft.XMLHTTP"); 
		} catch (E) { 
			xmlhttp = false; 
		} 
	} 
	if (!xmlhttp && typeof XMLHttpRequest!='undefined') { 
		xmlhttp = new XMLHttpRequest(); 
	}

	// first get the XSLT file
	var xsltProcessor = new XSLTProcessor();
	// Load the xsl file using synchronous (third param is set to false) XMLHttpRequest
	xmlhttp.open("GET", "/queryresult.xsl", false);
	xmlhttp.send(null);
	var xslRef = xmlhttp.responseXML;
	xsltProcessor.importStylesheet(xslRef);

function search() {
    // get the search string
    var query_str=document.queryform.querytext.value;
    // FIXME: Escape query_str
    if (query_str.length == 0)
	return;

    var req_string = '<?xml version="1.0" encoding="utf-8"?> <RequestWrapper xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:xsd="http://www.w3.org/2001/XMLSchema"> <Message xsi:type="Query"> <IsIndexListener>false</IsIndexListener> <Parts> <Part xsi:type="QueryPart_Human"> <Logic>Required</Logic> <QueryString>' + query_str + '</QueryString> </Part> </Parts> <MimeTypes /> <HitTypes /> <Sources /> <QueryDomain>Local System</QueryDomain> <MaxHits>100</MaxHits> </Message> </RequestWrapper> ';

    xmlhttp.onreadystatechange = state_change;
    xmlhttp.open("POST", "/", true);
    //XHR binary charset opt by mgran 2006 [http://mgran.blogspot.com]
    xmlhttp.overrideMimeType('text/txt; charset=utf-8'); // if charset is changed, need to handle bom
    //xmlhttp.overrideMimeType('text/txt; charset=x-user-defined');
    xmlhttp.send(req_string);

    // FIXME: Till I find a good way to show a busy cursor ...
    document.queryform.querytext.disabled=true;
    document.getElementById('busycursor').style.display='block';
    return false;
}

function onError(e)
{
    alert("Error " + e.target.status + " occurred while receiving the document.");
}

var ii=0

function state_change()
{
    //alert("help");
    if (xmlhttp.readyState==4) {
	// FIXME: Should also check for status 200

	//dump("Response:\n");
	//dump(xmlhttp.responseText);
	//dump("\n");
	res = xmlhttp.responseText;

	//alert(res.charCodeAt (0));
	//alert(res.charCodeAt (1));
	//alert(res.charCodeAt (2));
	//var debug_index = res.indexOf ('</ResponseWrapper>');
	//alert(res.charCodeAt(debug_index + 17));
	//alert(res.charCodeAt(debug_index + 18));
	//alert(res.charCodeAt(debug_index + 19));

	// if charset is x-user-defined split by \uF7FF
	// if charset is utf-8, split by FFFD
	// And dont ask me why!
	var responses = res.split('\uFFFD'); 
	var parser = new DOMParser();

	document.getElementById('busycursor').style.display='none';
	document.getElementById('NumMatches').style.display='block';
	document.getElementById('results').innerHTML="";
	var num_matches = 0;

	for (var i=0; i<responses.length; ++i) {
	    if (responses[i].length <= 0)
		continue;
	    dump(responses[i]);
	    dump('\n');

	    //document.getElementById('xml').innerHTML += (responses[i].length + "</br>");
	    var response_dom = parser.parseFromString(responses[i], "text/xml");

	    var num_matches_elems = response_dom.getElementsByTagName('NumMatches');
	    if (num_matches_elems.length > 0) {
		var n = parseInt (num_matches_elems[0].textContent);
		if (n > 0) {
		    num_matches += n;
		    document.getElementById('NumMatches').innerHTML=("(Showing " + num_matches + " matches)");
		}
	    }
	    //var hits = response_dom.getElementsByTagName('Hit');
	    //if (hits.length > 0) {
	    //    document.getElementById('results').innerHTML = ("<i>" + hits[0].getAttribute('Timestamp') + "</i>");
	    //    document.getElementById('xml').innerHTML = ("<i>" + hits[1].getAttribute('Timestamp') + "</i>");
	    //}
	    var fragment = xsltProcessor.transformToFragment(response_dom, document);
	    document.getElementById('results').appendChild(fragment);
	}
    }

    document.queryform.querytext.disabled=false;
}

function test()
{
    //document.getElementById('xml').innerHTML = ("<i>hello world</i> " + "foo");
    document.getElementById('busycursor').style.display='block';
}
</script>
</head>
<body>
    <form name="queryform" onsubmit='search(); return false;' action="POST">
	<p><input name="querytext" type="text" size="50" /><input type="submit" value="Search"/></p>
    </form></br><hr/>
    <!--<a href="" onclick='test(); return false;'>bbb</a></br>-->
    <div id="busycursor" style="text-align:center; display:none">Searching ...</div>
    <div id="NumMatches" style="display:none"></div>
<div id="xml"></div>
<div id="results"></div>
</body>
</html>
